{% extends 'base.html' %}
{% block title %}Add Block{% endblock %}
{% block extra_head %}
<script type="text/javascript">
    $(document).unload(function(){
        GUnload();
    });
    
    $(document).ready(function(){
        $("<div id=\"map_canvas\" class=\"location_picker_map\"></div>").insertBefore($("input.location_picker"));
        //$("input.location_picker").css("display", "none")
        var lat = "{{ center_lat }}";
        var lng = "{{ center_lng }}";
        var center = new google.maps.LatLng(lat, lng);
        var zoom_level = parseInt("{{ zoom_level }}");
        var mapOptions = {
            zoom: zoom_level,
            center: center,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        }
        var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
        
        var marker = new google.maps.Marker({
            position: center,
            map: map,
            draggable: true,
            animation: google.maps.Animation.DROP,
            title: ""
        });
        google.maps.event.addListener(map, 'click', function(event){
            updateMarker(event.latLng);
        });
        google.maps.event.addListener(marker, 'dragend', markerDragged);
        google.maps.event.addListener(marker, 'click', toggleBounce);
        
        function updateMarker(location){
            marker.setPosition(location);
            $("#id_center").attr("value", marker.getPosition().lat() + ',' + marker.getPosition().lng());
            //map.setCenter(location);
        }
        
        function toggleBounce(){
            if (marker.getAnimation() != null) {
                marker.setAnimation(null);
            }
            else {
                marker.setAnimation(google.maps.Animation.BOUNCE);
            }
        };
        
        function markerDragged(){
            //alert("was called" + marker.getPosition());
            $("#id_center").attr("value", marker.getPosition().lat() + ',' + marker.getPosition().lng());
            //map.setCenter(marker.getPosition(), zoom_level + 1);
        }
        
        $("#id_district").change(function(){
            filterBlocks($("#id_district").val());
        }).change();
        
        function filterBlocks(){
            $.get("/feeds/district-center/" + $("#id_district :selected").text() + "/", function(data){
                map.setCenter(new google.maps.LatLng(data.split(",")[0], data.split(",")[1]));
                map.setZoom(zoom_level + 4);
                updateMarker(new google.maps.LatLng(map.getCenter().lat(), map.getCenter().lng()));
            });
        };
        
        });
</script>
{% endblock %}
{% block content %}<h2>Add Block</h2>
<p>
    <form method="post" action="">
        {% csrf_token %}
        <table>
            {{ form.as_table }}
            <tr>
                <td>
                    <input type="submit" value="Submit"/>
                </td>
            </tr>
        </table>
    </form>
</p>{% endblock %}